{% extends "base.html" %}

{% block title %}Today's Walk - Cat Tracker{% endblock %}

{% block extra_css %}
<style>
    .date-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .date-header p {
        color: var(--text-secondary);
    }

    .log-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .quick-add-form {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .quick-add-form input {
        flex: 1;
    }

    .image-upload-small {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .image-upload-small label {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--bg-tertiary);
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: border-color 0.2s;
    }

    .image-upload-small label:hover {
        border-color: var(--accent-primary);
    }

    .image-upload-small input {
        display: none;
    }

    .image-upload-small .preview {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        display: none;
    }

    .sighting-card {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 1rem;
        background: var(--bg-tertiary);
        border-radius: 12px;
        margin-bottom: 0.75rem;
        border: 1px solid var(--border-color);
    }

    .sighting-card.hidden {
        display: none;
    }

    .sighting-info {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        flex: 1;
    }

    .cat-thumb {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        background: var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .sighting-details h3 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--text-primary);
    }

    .sighting-details .time {
        color: var(--accent-primary);
        font-size: 0.9rem;
        font-weight: 500;
    }

    .sighting-details .detail {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }

    .sighting-image {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        object-fit: cover;
        margin-top: 0.5rem;
        cursor: pointer;
    }

    .btn-remove {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0.25rem;
        transition: color 0.2s;
    }

    .btn-remove:hover {
        color: var(--danger-btn);
    }

    .cats-overview {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .cat-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        text-decoration: none;
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .cat-pill:hover {
        border-color: var(--accent-primary);
    }

    .cat-pill.seen {
        background: var(--success-bg);
        color: var(--success-text);
        border-color: var(--success-text);
    }

    .cat-pill img {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        object-fit: cover;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .modal img {
        max-width: 90%;
        max-height: 90%;
        border-radius: 8px;
    }

    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 2rem;
        color: white;
        background: none;
        border: none;
        cursor: pointer;
    }

    #todayCount {
        display: inline;
    }
</style>
{% endblock %}

{% block content %}
<div class="date-header">
    <h1>üö∂ Today's Walk</h1>
    <p id="todayDate"></p>
    <p class="timezone-info">Timezone: <span class="timezone-display"></span></p>
</div>

<!-- Log a Sighting -->
<div class="section">
    <h2>Log a Sighting</h2>
    
    <form action="/log-sighting" method="POST" enctype="multipart/form-data" class="log-form">
        <div class="form-group">
            <label for="cat_id">Which cat did you see?</label>
            <select name="cat_id" id="cat_id" required>
                <option value="">Select a cat...</option>
                {% for cat in cats %}
                <option value="{{ cat.id }}" data-cat-id="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="location">Location (optional)</label>
                <input type="text" name="location" id="location" placeholder="e.g., Near the park bench">
            </div>
            <div class="form-group">
                <label for="notes">Notes (optional)</label>
                <input type="text" name="notes" id="notes" placeholder="e.g., Looked healthy">
            </div>
        </div>

        <div class="form-group">
            <label>Photo of this sighting (optional)</label>
            <div class="image-upload-small">
                <label for="sighting_image">
                    üì∑ Add Photo
                    <input type="file" name="image" id="sighting_image" accept="image/*" onchange="previewSightingImage(this)">
                </label>
                <img id="sightingPreview" class="preview" alt="Preview">
            </div>
        </div>

        <button type="submit" class="btn btn-primary">üêæ Log Sighting</button>
    </form>

    <form action="/quick-add-cat" method="POST" class="quick-add-form">
        <input type="text" name="name" placeholder="New cat's name" required>
        <button type="submit" class="btn btn-secondary">+ Add Cat</button>
    </form>
</div>

<!-- Today's Sightings -->
<div class="section">
    <h2>Today's Sightings (<span id="todayCount">0</span>)</h2>
    
    <div id="sightingsList">
        {% for sighting in sightings %}
        <div class="sighting-card" data-iso="{{ sighting.iso_date }}" data-cat-id="{{ sighting.cat_id }}">
            <div class="sighting-info">
                {% if sighting.cat_image_src %}
                <img src="{{ sighting.cat_image_src }}" alt="{{ sighting.cat_name }}" class="cat-thumb">
                {% else %}
                <div class="cat-thumb">üê±</div>
                {% endif %}
                <div class="sighting-details">
                    <h3>{{ sighting.cat_name }}</h3>
                    <p class="time">üïê <span data-iso="{{ sighting.iso_date }}" data-format="time"></span></p>
                    {% if sighting.location %}
                    <p class="detail">üìç {{ sighting.location }}</p>
                    {% endif %}
                    {% if sighting.notes %}
                    <p class="detail">üìù {{ sighting.notes }}</p>
                    {% endif %}
                    {% if sighting.sighting_image_src %}
                    <img src="{{ sighting.sighting_image_src }}" alt="Sighting photo" class="sighting-image" onclick="showModal(this.src)">
                    {% endif %}
                </div>
            </div>
            <form action="/remove-sighting/{{ sighting.id }}" method="POST" style="display: inline;">
                <button type="submit" class="btn-remove" title="Remove">√ó</button>
            </form>
        </div>
        {% endfor %}
    </div>
    
    <p class="empty" id="emptyMessage" style="display: none;">No cats spotted yet today. Time for a walk! üö∂</p>
</div>

<!-- Cat Overview -->
<div class="section">
    <h2>Your Cats</h2>
    <div class="cats-overview" id="catsOverview">
        {% for cat in cats %}
        <a href="/cats/{{ cat.id }}" class="cat-pill" data-cat-id="{{ cat.id }}">
            {% if cat.image_src %}
            <img src="{{ cat.image_src }}" alt="">
            {% endif %}
            {{ cat.name }}
            <span class="seen-check" style="display: none;">‚úì</span>
        </a>
        {% endfor %}
        
        {% if not cats %}
        <p class="text-muted">No cats yet. Add your first cat above!</p>
        {% endif %}
    </div>
</div>

<!-- Image Modal -->
<div class="modal" id="imageModal" onclick="hideModal()">
    <button class="modal-close" onclick="hideModal()">√ó</button>
    <img id="modalImage" src="" alt="Full size">
</div>

<script>
// Set today's date in user's locale
document.getElementById('todayDate').textContent = new Date().toLocaleDateString(undefined, {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});

// Filter sightings to show only today's in user's timezone
function filterTodaySightings() {
    const sightingCards = document.querySelectorAll('.sighting-card');
    const seenCatIds = new Set();
    let todayCount = 0;
    
    sightingCards.forEach(card => {
        const iso = card.getAttribute('data-iso');
        const catId = card.getAttribute('data-cat-id');
        
        if (isToday(iso)) {
            card.classList.remove('hidden');
            seenCatIds.add(catId);
            todayCount++;
        } else {
            card.classList.add('hidden');
        }
    });
    
    // Update count
    document.getElementById('todayCount').textContent = todayCount;
    
    // Show/hide empty message
    document.getElementById('emptyMessage').style.display = todayCount === 0 ? 'block' : 'none';
    
    // Update cat pills to show which ones were seen today
    document.querySelectorAll('.cat-pill').forEach(pill => {
        const catId = pill.getAttribute('data-cat-id');
        const checkMark = pill.querySelector('.seen-check');
        
        if (seenCatIds.has(catId)) {
            pill.classList.add('seen');
            if (checkMark) checkMark.style.display = 'inline';
        } else {
            pill.classList.remove('seen');
            if (checkMark) checkMark.style.display = 'none';
        }
    });
    
    // Update select options to show checkmarks
    document.querySelectorAll('#cat_id option').forEach(option => {
        const catId = option.getAttribute('data-cat-id');
        if (catId && seenCatIds.has(catId)) {
            if (!option.textContent.includes('‚úì')) {
                option.textContent = option.textContent + ' ‚úì';
            }
        }
    });
}

// Run after times are updated
document.addEventListener('DOMContentLoaded', function() {
    updateAllTimes();
    filterTodaySightings();
});

function previewSightingImage(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var preview = document.getElementById('sightingPreview');
            preview.src = e.target.result;
            preview.style.display = 'block';
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function showModal(src) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').classList.add('show');
}

function hideModal() {
    document.getElementById('imageModal').classList.remove('show');
}
</script>
{% endblock %}
