{% extends "base.html" %}

{% block title %}{{ cat.name }} - Cat Tracker{% endblock %}

{% block extra_css %}
<style>
    .back-link {
        display: inline-block;
        color: var(--accent-primary);
        text-decoration: none;
        margin-bottom: 1rem;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    .cat-header {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 2rem;
    }

    .cat-image-container {
        position: relative;
    }

    .cat-image {
        width: 250px;
        height: 250px;
        border-radius: 16px;
        overflow: hidden;
        background: var(--bg-tertiary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4rem;
        cursor: pointer;
    }

    .cat-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .remove-pfp-btn {
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--danger-btn);
        color: white;
        border: none;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.75rem;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
        white-space: nowrap;
    }

    .cat-image-container:hover .remove-pfp-btn {
        opacity: 1;
    }

    .cat-details h1 {
        margin: 0 0 0.5rem;
        color: var(--text-primary);
    }

    .cat-details .description {
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
    }

    .stats {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .stat .value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .stat .label {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .actions {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .edit-form {
        display: none;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .edit-form.show {
        display: block;
    }

    .delete-confirm {
        display: none;
        margin-top: 1rem;
        padding: 1rem;
        background: var(--danger-bg);
        border-radius: 8px;
        border: 1px solid var(--danger-text);
    }

    .delete-confirm.show {
        display: block;
    }

    .delete-confirm p {
        color: var(--danger-text);
        margin: 0 0 1rem;
    }

    /* ============== TABS ============== */
    .tabs {
        display: flex;
        gap: 0;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 1.5rem;
        overflow-x: auto;
    }

    .tab-btn {
        padding: 1rem 1.5rem;
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .tab-btn:hover {
        color: var(--text-primary);
    }

    .tab-btn.active {
        color: var(--accent-primary);
        border-bottom-color: var(--accent-primary);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* ============== GALLERY ============== */
    .gallery-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .gallery-header h3 {
        margin: 0;
        color: var(--text-primary);
    }

    .gallery-info {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: var(--bg-tertiary);
        border-radius: 8px;
        border-left: 3px solid var(--accent-primary);
    }

    .upload-form {
        display: none;
        padding: 1.5rem;
        background: var(--bg-tertiary);
        border-radius: 12px;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
    }

    .upload-form.show {
        display: block;
    }

    .upload-area {
        border: 3px dashed var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.2s, background 0.2s;
        margin-bottom: 1rem;
    }

    .upload-area:hover {
        border-color: var(--accent-primary);
        background: var(--bg-secondary);
    }

    .upload-area.dragover {
        border-color: var(--accent-primary);
        background: var(--bg-secondary);
    }

    .upload-area input {
        display: none;
    }

    .upload-area .icon {
        font-size: 3rem;
        margin-bottom: 0.5rem;
    }

    .upload-area p {
        margin: 0;
        color: var(--text-secondary);
    }

    .upload-area .hint {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
    }

    .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .preview-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
    }

    .preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .preview-item .remove {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 20px;
        height: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
    }

    .gallery-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 12px;
        overflow: hidden;
        background: var(--bg-tertiary);
        cursor: pointer;
        transition: transform 0.2s;
    }

    .gallery-item:hover {
        transform: scale(1.02);
    }

    .gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .gallery-item .source-badge {
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 500;
    }

    .gallery-item .source-badge.sighting {
        background: var(--accent-primary);
        color: white;
    }

    .gallery-item .source-badge.gallery {
        background: var(--success-bg);
        color: var(--success-text);
    }

    .gallery-item .overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 0.5rem;
        background: linear-gradient(transparent, rgba(0,0,0,0.8));
        color: white;
        font-size: 0.75rem;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .gallery-item:hover .overlay {
        opacity: 1;
    }

    .gallery-item .photo-actions {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: flex;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .gallery-item:hover .photo-actions {
        opacity: 1;
    }

    .photo-action-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.1s;
    }

    .photo-action-btn:hover {
        transform: scale(1.1);
    }

    .photo-action-btn.set-profile {
        background: var(--accent-primary);
        color: white;
    }

    .photo-action-btn.delete {
        background: var(--danger-btn);
        color: white;
    }

    .empty-gallery {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
    }

    .empty-gallery .icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    /* ============== TIMELINE ============== */
    .timeline-item {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 1rem;
        padding: 1rem;
        background: var(--bg-tertiary);
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border: 1px solid var(--border-color);
    }

    .timeline-date .date {
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.95rem;
    }

    .timeline-date .time {
        color: var(--text-muted);
        font-size: 0.85rem;
    }

    .timeline-content p {
        margin: 0.25rem 0;
        color: var(--text-secondary);
    }

    .timeline-content .muted {
        color: var(--text-muted);
        font-style: italic;
    }

    .timeline-content img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        margin-top: 0.5rem;
        cursor: pointer;
    }

    .empty {
        color: var(--text-muted);
        text-align: center;
        padding: 2rem;
    }

    /* ============== MODAL ============== */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }

    .modal.show {
        display: flex;
    }

    .modal img {
        max-width: 90%;
        max-height: 75%;
        border-radius: 8px;
    }

    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 2rem;
        color: white;
        background: none;
        border: none;
        cursor: pointer;
    }

    .modal-caption {
        color: white;
        margin-top: 1rem;
        text-align: center;
        max-width: 80%;
    }

    .modal-source {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-bottom: 0.5rem;
    }

    .modal-source.sighting {
        background: var(--accent-primary);
    }

    .modal-source.gallery {
        background: #27ae60;
    }

    .modal-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 3rem;
        color: white;
        background: none;
        border: none;
        cursor: pointer;
        padding: 1rem;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .modal-nav:hover {
        opacity: 1;
    }

    .modal-nav.prev {
        left: 1rem;
    }

    .modal-nav.next {
        right: 1rem;
    }

    /* ============== RESPONSIVE ============== */
    @media (max-width: 600px) {
        .cat-header {
            grid-template-columns: 1fr;
        }

        .cat-image-container {
            width: fit-content;
            margin: 0 auto;
        }

        .cat-image {
            width: 200px;
            height: 200px;
        }

        .remove-pfp-btn {
            opacity: 1;
        }

        .timeline-item {
            grid-template-columns: 1fr;
        }

        .gallery-grid {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        }

        .stats {
            gap: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<a href="/cats" class="back-link">‚Üê Back to all cats</a>

<div class="section">
    <div class="cat-header">
        <div class="cat-image-container">
            <div class="cat-image" onclick="{% if cat.image_src %}showModal(0, 'profile'){% endif %}">
                {% if cat.image_src %}
                <img src="{{ cat.image_src }}" alt="{{ cat.name }}">
                {% else %}
                üê±
                {% endif %}
            </div>
            {% if cat.image_src %}
            <form action="/cats/{{ cat.id }}/remove-profile-photo" method="POST" style="display: inline;" onsubmit="return confirm('Remove profile photo?')">
                <button type="submit" class="remove-pfp-btn">üóëÔ∏è Remove Photo</button>
            </form>
            {% endif %}
        </div>

        <div class="cat-details">
            <h1>{{ cat.name }}</h1>
            {% if cat.description %}
            <p class="description">{{ cat.description }}</p>
            {% endif %}

            <div class="stats">
                <div class="stat">
                    <span class="value">{{ sighting_count }}</span>
                    <span class="label">Sightings</span>
                </div>
                <div class="stat">
                    <span class="value">{{ photos|length }}</span>
                    <span class="label">Photos</span>
                </div>
                <div class="stat">
                    <span class="value">{{ last_seen }}</span>
                    <span class="label">Last Seen</span>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-primary btn-small" onclick="toggleEdit()">‚úèÔ∏è Edit</button>
                <button class="btn btn-danger btn-small" onclick="toggleDelete()">üóëÔ∏è Delete Cat</button>
            </div>

            <!-- Edit Form -->
            <div class="edit-form" id="editForm">
                <form action="/cats/{{ cat.id }}/edit" method="POST" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" name="name" id="name" value="{{ cat.name }}" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea name="description" id="description" rows="2">{{ cat.description or '' }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="image">New Profile Photo (optional)</label>
                        <input type="file" name="image" id="image" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-primary btn-small">Save</button>
                    <button type="button" class="btn btn-secondary btn-small" onclick="toggleEdit()">Cancel</button>
                </form>
            </div>

            <!-- Delete Confirm -->
            <div class="delete-confirm" id="deleteConfirm">
                <p>Are you sure you want to delete {{ cat.name }}? This will also delete all photos and sighting records.</p>
                <form action="/cats/{{ cat.id }}/delete" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger btn-small">Yes, Delete</button>
                </form>
                <button class="btn btn-secondary btn-small" onclick="toggleDelete()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Tabs Section -->
<div class="section">
    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('gallery')">üì∑ Photos ({{ photos|length }})</button>
        <button class="tab-btn" onclick="showTab('sightings')">üëÅÔ∏è Sightings ({{ sighting_count }})</button>
    </div>

    <!-- Gallery Tab -->
    <div class="tab-content active" id="gallery-tab">
        <div class="gallery-header">
            <h3>All Photos</h3>
            <button class="btn btn-primary btn-small" onclick="toggleUploadForm()">+ Add Old Photos</button>
        </div>
        
        <p class="gallery-info">
            üì∑ All photos in one place! Sighting photos (blue badge) and uploaded photos (green badge) are sorted by date.
        </p>

        <!-- Upload Form for Old Photos -->
        <div class="upload-form" id="uploadForm">
            <h4 style="margin-top: 0; color: var(--text-primary);">Upload Previous Photos</h4>
            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                Add photos you already have from your phone or computer.
            </p>
            <form action="/cats/{{ cat.id }}/photos/add" method="POST" enctype="multipart/form-data" id="photoUploadForm">
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('photoInput').click()">
                    <div class="icon">üì∑</div>
                    <p>Click to select photos or drag & drop</p>
                    <p class="hint">You can select multiple photos at once</p>
                    <input type="file" name="photos" id="photoInput" accept="image/*" multiple onchange="handleFileSelect(this)">
                </div>
                
                <div class="preview-grid" id="previewGrid"></div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="photo_date">Date taken (optional)</label>
                        <input type="date" name="photo_date" id="photo_date">
                    </div>
                    <div class="form-group">
                        <label for="photo_time">Time taken (optional)</label>
                        <input type="time" name="photo_time" id="photo_time">
                    </div>
                </div>

                <div class="form-group">
                    <label for="caption">Caption (optional)</label>
                    <input type="text" name="caption" id="caption" placeholder="e.g., First time I saw this cutie">
                </div>

                <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>Upload Photos</button>
                <button type="button" class="btn btn-secondary" onclick="toggleUploadForm()">Cancel</button>
            </form>
        </div>

        <!-- Gallery Grid -->
        {% if photos %}
        <div class="gallery-grid">
            {% for photo in photos %}
            <div class="gallery-item" onclick="showModal({{ loop.index0 }}, 'photos')">
                <img src="{{ photo.image_src }}" alt="Photo of {{ cat.name }}">
                
                <!-- Source Badge -->
                <span class="source-badge {{ photo.source }}">
                    {% if photo.source == 'sighting' %}üìç Sighting{% else %}üìÅ Uploaded{% endif %}
                </span>
                
                <div class="overlay">
                    {% if photo.display_date %}üìÖ {{ photo.display_date }}{% endif %}
                    {% if photo.display_time %} {{ photo.display_time }}{% endif %}
                    {% if photo.location %}<br>üìç {{ photo.location }}{% endif %}
                    {% if photo.caption and photo.source == 'gallery' %}<br>{{ photo.caption }}{% endif %}
                </div>
                
                <div class="photo-actions" onclick="event.stopPropagation()">
                    <form action="/cats/{{ cat.id }}/photos/{{ photo.source }}/{{ photo.id }}/set-profile" method="POST" style="display:inline;">
                        <button type="submit" class="photo-action-btn set-profile" title="Set as profile photo">‚≠ê</button>
                    </form>
                    <form action="/cats/{{ cat.id }}/photos/{{ photo.source }}/{{ photo.id }}/delete" method="POST" style="display:inline;" onsubmit="return confirm('{% if photo.source == 'sighting' %}Remove photo from this sighting?{% else %}Delete this photo?{% endif %}')">
                        <button type="submit" class="photo-action-btn delete" title="Delete">√ó</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-gallery">
            <div class="icon">üì∑</div>
            <p>No photos yet!</p>
            <p style="margin-top: 0.5rem;">Photos will appear here when you:</p>
            <ul style="text-align: left; display: inline-block; margin-top: 0.5rem; color: var(--text-secondary);">
                <li>Log a sighting with a photo</li>
                <li>Upload old photos using the button above</li>
            </ul>
        </div>
        {% endif %}
    </div>

    <!-- Sightings Tab -->
    <div class="tab-content" id="sightings-tab">
        <h3>Sighting History</h3>
        
        {% if sightings %}
            {% for sighting in sightings %}
            <div class="timeline-item">
                <div class="timeline-date">
                    <span class="date">{{ sighting.display_date }}</span>
                    <span class="time">üïê {{ sighting.display_time }}</span>
                </div>
                <div class="timeline-content">
                    {% if sighting.location %}
                    <p>üìç {{ sighting.location }}</p>
                    {% endif %}
                    {% if sighting.notes %}
                    <p>üìù {{ sighting.notes }}</p>
                    {% endif %}
                    {% if not sighting.location and not sighting.notes and not sighting.image_src %}
                    <p class="muted">Spotted!</p>
                    {% endif %}
                    {% if sighting.image_src %}
                    <img src="{{ sighting.image_src }}" alt="Sighting photo" onclick="showSingleImage('{{ sighting.image_src }}', '{{ sighting.display_date }} at {{ sighting.display_time }}')">
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="empty">No sightings recorded yet. Log a sighting from the home page!</p>
        {% endif %}
    </div>
</div>

<!-- Image Modal -->
<div class="modal" id="imageModal">
    <button class="modal-close" onclick="hideModal()">√ó</button>
    <button class="modal-nav prev" onclick="navigateModal(-1)">‚Äπ</button>
    <img id="modalImage" src="" alt="Full size">
    <div class="modal-caption">
        <span class="modal-source" id="modalSource"></span>
        <div id="modalCaptionText"></div>
    </div>
    <button class="modal-nav next" onclick="navigateModal(1)">‚Ä∫</button>
</div>

<script>
// Tab switching
function showTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.add('active');
}

// Edit/Delete toggles
function toggleEdit() {
    document.getElementById('editForm').classList.toggle('show');
    document.getElementById('deleteConfirm').classList.remove('show');
}

function toggleDelete() {
    document.getElementById('deleteConfirm').classList.toggle('show');
    document.getElementById('editForm').classList.remove('show');
}

// Upload form
function toggleUploadForm() {
    document.getElementById('uploadForm').classList.toggle('show');
    document.getElementById('previewGrid').innerHTML = '';
    document.getElementById('photoInput').value = '';
    document.getElementById('uploadBtn').disabled = true;
}

// File selection and preview
let selectedFiles = [];

function handleFileSelect(input) {
    selectedFiles = Array.from(input.files);
    updatePreview();
}

function updatePreview() {
    const grid = document.getElementById('previewGrid');
    grid.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `
                <img src="${e.target.result}" alt="Preview">
                <button type="button" class="remove" onclick="removeFile(${index})">√ó</button>
            `;
            grid.appendChild(div);
        };
        reader.readAsDataURL(file);
    });
    
    document.getElementById('uploadBtn').disabled = selectedFiles.length === 0;
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    
    const dt = new DataTransfer();
    selectedFiles.forEach(file => dt.items.add(file));
    document.getElementById('photoInput').files = dt.files;
    
    updatePreview();
}

// Drag and drop
const uploadArea = document.getElementById('uploadArea');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
    if (files.length > 0) {
        selectedFiles = files;
        
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        document.getElementById('photoInput').files = dt.files;
        
        updatePreview();
    }
});

// Modal for photos
const allPhotos = [
    {% for photo in photos %}
    {
        src: "{{ photo.image_src }}",
        source: "{{ photo.source }}",
        displayDate: "{{ photo.display_date }}",
        displayTime: "{{ photo.display_time }}",
        location: "{{ photo.location or '' }}",
        caption: "{{ photo.caption or '' }}"
    },
    {% endfor %}
];

let currentPhotoIndex = 0;
let currentMode = 'photos';
let profileSrc = "{{ cat.image_src }}";

function showModal(index, mode) {
    currentMode = mode;
    currentPhotoIndex = index;
    
    const modal = document.getElementById('imageModal');
    const img = document.getElementById('modalImage');
    const sourceEl = document.getElementById('modalSource');
    const captionEl = document.getElementById('modalCaptionText');
    
    if (mode === 'profile') {
        img.src = profileSrc;
        sourceEl.textContent = 'Profile Photo';
        sourceEl.className = 'modal-source';
        captionEl.textContent = '{{ cat.name }}';
        document.querySelectorAll('.modal-nav').forEach(btn => btn.style.display = 'none');
    } else {
        const photo = allPhotos[index];
        img.src = photo.src;
        
        if (photo.source === 'sighting') {
            sourceEl.textContent = 'üìç From Sighting';
            sourceEl.className = 'modal-source sighting';
        } else {
            sourceEl.textContent = 'üìÅ Uploaded Photo';
            sourceEl.className = 'modal-source gallery';
        }
        
        let caption = '';
        if (photo.displayDate) caption += 'üìÖ ' + photo.displayDate;
        if (photo.displayTime) caption += ' at ' + photo.displayTime;
        if (photo.location) caption += '<br>üìç ' + photo.location;
        if (photo.caption && photo.source === 'gallery') caption += '<br>' + photo.caption;
        captionEl.innerHTML = caption || '';
        
        document.querySelectorAll('.modal-nav').forEach(btn => btn.style.display = allPhotos.length > 1 ? 'block' : 'none');
    }
    
    modal.classList.add('show');
}

function hideModal() {
    document.getElementById('imageModal').classList.remove('show');
}

function navigateModal(direction) {
    if (currentMode !== 'photos' || allPhotos.length <= 1) return;
    
    currentPhotoIndex += direction;
    if (currentPhotoIndex < 0) currentPhotoIndex = allPhotos.length - 1;
    if (currentPhotoIndex >= allPhotos.length) currentPhotoIndex = 0;
    
    const photo = allPhotos[currentPhotoIndex];
    document.getElementById('modalImage').src = photo.src;
    
    const sourceEl = document.getElementById('modalSource');
    if (photo.source === 'sighting') {
        sourceEl.textContent = 'üìç From Sighting';
        sourceEl.className = 'modal-source sighting';
    } else {
        sourceEl.textContent = 'üìÅ Uploaded Photo';
        sourceEl.className = 'modal-source gallery';
    }
    
    let caption = '';
    if (photo.displayDate) caption += 'üìÖ ' + photo.displayDate;
    if (photo.displayTime) caption += ' at ' + photo.displayTime;
    if (photo.location) caption += '<br>üìç ' + photo.location;
    if (photo.caption && photo.source === 'gallery') caption += '<br>' + photo.caption;
    document.getElementById('modalCaptionText').innerHTML = caption || '';
}

function showSingleImage(src, caption) {
    const modal = document.getElementById('imageModal');
    document.getElementById('modalImage').src = src;
    document.getElementById('modalSource').textContent = 'üìç Sighting Photo';
    document.getElementById('modalSource').className = 'modal-source sighting';
    document.getElementById('modalCaptionText').textContent = caption || '';
    document.querySelectorAll('.modal-nav').forEach(btn => btn.style.display = 'none');
    modal.classList.add('show');
}

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (!document.getElementById('imageModal').classList.contains('show')) return;
    
    if (e.key === 'Escape') hideModal();
    if (e.key === 'ArrowLeft') navigateModal(-1);
    if (e.key === 'ArrowRight') navigateModal(1);
});

// Close modal when clicking outside image
document.getElementById('imageModal').addEventListener('click', (e) => {
    if (e.target.id === 'imageModal') hideModal();
});
</script>
{% endblock %}